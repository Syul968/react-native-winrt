<!--
***********************************************************************************************
Copyright (C) Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <PropertyGroup>
        <!-- Only do this for MSBuild versions below 16.0
             as it is since done automatically, see https://github.com/microsoft/msbuild/pull/3605-->
        <MSBuildAllProjects Condition="'$(MSBuildToolsVersion)'  &lt;= '15'">$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <PropertyGroup>
        <Error Condition="'$(CppWinRTPackageDir)' == ''">CppWinRTPackageDir not specified!</Error>
        <CppWinRTPath Condition="'$(CppWinRTPackage)' == 'true' and '$(CppWinRTPath)'==''">$(CppWinRTPackageDir)bin\</CppWinRTPath>

        <RnWinRTVerbosity Condition="'$(RnWinRTVerbosity)' == ''">normal</RnWinRTVerbosity>
        <RnWinRTCommandVerbosity Condition="'$(RnWinRTVerbosity)' == 'high'">-verbose</RnWinRTCommandVerbosity>
        <Error Condition="'$(RnWinRTPath)' == ''">RnWinRTPath not specified!</Error>

        <GeneratedFilesDir Condition="'$(GeneratedFilesDir)' == ''">$(IntDir)Generated Files\</GeneratedFilesDir>
        <!--TEMP: Override NuGet SDK's erroneous setting in uap.props -->
        <WindowsSDK_MetadataFoundationPath Condition="('$(WindowsSDK_MetadataFoundationPath)'!='') And !Exists($(WindowsSDK_MetadataFoundationPath))">$(WindowsSDK_MetadataPathVersioned)</WindowsSDK_MetadataFoundationPath>
        <!-- CAExcludePath is used to set an environment variable, so make sure this is defined on a single line. -->
        <CAExcludePath>$(GeneratedFilesDir);$(CAExcludePath)</CAExcludePath>

        <!-- Note: Before* targets run before Compute* targets. -->
        <BeforeClCompileTargets>
            $(BeforeClCompileTargets);RnWinRTMakeProjections;
        </BeforeClCompileTargets>
    </PropertyGroup>

    <Target Name="GetRnWinRTWinMDInputs"
            DependsOnTargets="ResolveAssemblyReferences"
            Returns="@(RnWinRTWinMDInputs)">
        <ItemGroup>
            <_RnWinRTWinMDInputs Remove="@(_RnWinRTWinMDInputs)" />
            <_RnWinRTWinMDInputs Include="$(WindowsSDK_MetadataPathVersioned)\**\*.winmd" />
            <RnWinRTWinMDInputs Include="@(_RnWinRTWinMDInputs)">
                <WinMDPath>%(FullPath)</WinMDPath>
            </RnWinRTWinMDInputs>
        </ItemGroup>
        <Message Text="RnWinRTWinMDInputs: @(RnWinRTWinMDInputs->'%(WinMDPath)')" Importance="$(RnWinRTVerbosity)"/>
    </Target>

    <Target Name="RnWinRTMakeRsp"
            DependsOnTargets="GetRnWinRTWinMDInputs"
            Inputs="$(RnWinRTParameters);@(RnWinRTWinMDInputs)"
            Outputs="$(IntDir)rnwinrt.rsp">
        <ItemGroup>
            <_RnwinrtInputs Remove="@(_RnwinrtInputs)"/>
            <_RnwinrtInputs Include="@(RnWinRTWinMDInputs)"/>
        </ItemGroup>
        <PropertyGroup>
            <_RnwinrtParameters>$(RnWinRTCommandVerbosity) $(RnWinRTParameters)</_RnwinrtParameters>
            <_RnwinrtParameters>$(_RnwinrtParameters) @(_RnwinrtInputs->'-in &quot;%(WinMDPath)&quot;', '&#x0d;&#x0a;')</_RnwinrtParameters>
            <_RnwinrtParameters>$(_RnwinrtParameters) -out &quot;$(GeneratedFilesDir).&quot;</_RnwinrtParameters>
        </PropertyGroup>
        <!-- Always write the rnwinrt.rsp file when the target runs, because the file is used as the output of this target. -->
        <WriteLinesToFile
            File="$(IntDir)rnwinrt.rsp" Lines="$(_RnwinrtParameters)"
            ContinueOnError="true" Overwrite="true" />
    </Target>

    <Target Name="RnWinRTMakeProjections"
          DependsOnTargets="RnWinRTMakeRsp"
          Inputs="$(IntDir)rnwinrt.rsp"
          Outputs="$(GeneratedFilesDir)rnwinrt\Projections.g.h';$(GeneratedFilesDir)rnwinrt\Projections.g.cpp;$(GeneratedFilesDir)rnwinrt\ProjectedValueConverters.g.h';">
        <PropertyGroup>
            <RnWinRTPathCommand>$(RnWinRTExe) %40"$(IntDir)rnwinrt.rsp"</RnWinRTPathCommand>
        </PropertyGroup>
        <Message Text="$(RnWinRTPathCommand)" Importance="$(RnWinRTVerbosity)" />
        <Exec Command="$(RnWinRTPathCommand)" />
    </Target>

</Project>
